'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';
import { Button } from '@/components/ui/Button';
import { Switch } from '@/components/ui/Switch';
import { motion } from 'framer-motion';
import { 
  Cookie, 
  Shield, 
  Settings, 
  CheckCircle,
  XCircle,
  Info,
  AlertCircle,
  BarChart3,
  Users,
  Globe,
  RefreshCw
} from 'lucide-react';

// Definir el tipo para las preferencias de cookies
type CookiePreferences = {
  necessary: boolean;
  analytics: boolean;
  preferences: boolean;
  marketing: boolean;
};

interface CookieType {
  id: keyof CookiePreferences;
  name: string;
  description: string;
  required: boolean;
  examples: string[];
  icon: any;
}

interface CookiesManagerProps {
  cookieTypes: CookieType[];
}

export function CookiesManager({ cookieTypes }: CookiesManagerProps) {
  const [cookiePreferences, setCookiePreferences] = useState<CookiePreferences>({
    necessary: true,
    analytics: false,
    preferences: false,
    marketing: false
  });
  const [showSettings, setShowSettings] = useState(false);

  const handleCookieToggle = (id: keyof CookiePreferences) => {
    if (id === 'necessary') return;
    setCookiePreferences(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const handleSavePreferences = () => {
    localStorage.setItem('nyxara-cookie-preferences', JSON.stringify(cookiePreferences));
    setShowSettings(false);
  };

  const handleAcceptAll = () => {
    const allAccepted: CookiePreferences = {
      necessary: true,
      analytics: true,
      preferences: true,
      marketing: true
    };
    
    setCookiePreferences(allAccepted);
    localStorage.setItem('nyxara-cookie-preferences', JSON.stringify(allAccepted));
    setShowSettings(false);
  };

  const handleRejectAll = () => {
    const rejected: CookiePreferences = {
      necessary: true,
      analytics: false,
      preferences: false,
      marketing: false
    };
    
    setCookiePreferences(rejected);
    localStorage.setItem('nyxara-cookie-preferences', JSON.stringify(rejected));
    setShowSettings(false);
  };

  useEffect(() => {
    const saved = localStorage.getItem('nyxara-cookie-preferences');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        // Validar que el objeto parseado tenga la estructura correcta
        const validated: CookiePreferences = {
          necessary: typeof parsed.necessary === 'boolean' ? parsed.necessary : true,
          analytics: typeof parsed.analytics === 'boolean' ? parsed.analytics : false,
          preferences: typeof parsed.preferences === 'boolean' ? parsed.preferences : false,
          marketing: typeof parsed.marketing === 'boolean' ? parsed.marketing : false
        };
        setCookiePreferences(validated);
      } catch (error) {
        console.error('Error parsing cookie preferences:', error);
      }
    }
  }, []);

  return (
    <>
      {/* Aquí va la parte interactiva de tu código */}
      {/* Cookie Types con switches, botones de acción, etc. */}
      
      <div className="max-w-2xl mx-auto mb-12">
        <Card className="border-gray-800">
          <CardHeader className="text-center">
            <CardTitle className="text-2xl flex items-center justify-center gap-3">
              <Settings className="h-6 w-6 text-nyxara-primary" />
              Gestiona Tus Cookies
            </CardTitle>
            <p className="text-gray-400">
              Tienes control total sobre las cookies que aceptas
            </p>
          </CardHeader>
          <CardContent>
            <div className="space-y-6">
              {/* Current Preferences */}
              <div className="bg-gray-900/50 rounded-xl p-6">
                <h4 className="font-bold mb-4 flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-400" />
                  Preferencias Actuales
                </h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {(Object.keys(cookiePreferences) as Array<keyof CookiePreferences>).map((key) => (
                    <div key={key} className="text-center">
                      <div className={`w-3 h-3 rounded-full mx-auto mb-2 ${
                        cookiePreferences[key] ? 'bg-green-500' : 'bg-gray-600'
                      }`} />
                      <span className="text-sm capitalize">{key}</span>
                      <div className="text-xs text-gray-500">
                        {cookiePreferences[key] ? 'Activado' : 'Desactivado'}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Action Buttons */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <Button 
                  onClick={handleAcceptAll}
                  className="gap-2 bg-gradient-to-r from-green-500 to-emerald-500"
                >
                  <CheckCircle className="h-4 w-4" />
                  Aceptar Todas
                </Button>
                <Button 
                  onClick={handleRejectAll}
                  variant="outline"
                  className="gap-2"
                >
                  <XCircle className="h-4 w-4" />
                  Rechazar No Esenciales
                </Button>
                <Button 
                  onClick={() => setShowSettings(!showSettings)}
                  variant="outline"
                  className="gap-2"
                >
                  <Settings className="h-4 w-4" />
                  Personalizar
                </Button>
              </div>

              {/* Custom Settings */}
              {showSettings && (
                <motion.div
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: 'auto' }}
                  className="overflow-hidden"
                >
                  <div className="mt-6 pt-6 border-t border-gray-800">
                    <h4 className="font-bold mb-4">Configuración Personalizada</h4>
                    <div className="space-y-4">
                      {cookieTypes
                        .filter(type => !type.required)
                        .map((type) => (
                          <div key={type.id} className="flex items-center justify-between p-3 bg-gray-900/30 rounded-lg">
                            <div>
                              <div className="font-medium">{type.name}</div>
                              <div className="text-sm text-gray-400">{type.description}</div>
                            </div>
                            <Switch
                              checked={cookiePreferences[type.id]}
                              onCheckedChange={() => handleCookieToggle(type.id)}
                            />
                          </div>
                        ))}
                      <div className="flex gap-4">
                        <Button onClick={handleSavePreferences} className="flex-1">
                          Guardar Preferencias
                        </Button>
                        <Button variant="outline" onClick={() => setShowSettings(false)}>
                          Cancelar
                        </Button>
                      </div>
                    </div>
                  </div>
                </motion.div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  );
}